<head>
    <meta charset="utf-8">
    <title>西行记自动构建</title>
    <meta name="viewport"
        content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="true" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="x5-fullscreen" content="true" />
    <meta name="360-fullscreen" content="true" />
    <style>
        html,
        body {
            padding: 0;
            border: 0;
            margin: 0;
            height: 100%;
        }
    </style>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 开发环境版本，包含了有帮助的命令行警告 -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.1/TweenMax.min.js"> </script>
</head>

<body>
    <div id="app">
        <el-container>
            <el-container>
                <el-main>
                    <span>
                        <img src='./logo.png' style="margin-top: 0px;width:130px;"></img>
                        <img src='./gamelogo.png' style="margin-left: 20px;margin-top: 0px;width:100px;"></img>
                    </span>
                    <br></br>
                    <font face="微软雅黑" color="gray" size="4" style="font-weight:550;">配置</font>
                    <el-divider content-position="right">
                        <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                            <el-button type="primary" :icon="task.config.isbuild?'el-icon-loading':'el-icon-sugar'"
                                :disabled="disabled" @click="buildconfig()" round>Build</el-button>
                        </el-tooltip>
                    </el-divider>

                    <el-steps :active="task.config.phase" simple style="margin-top: 20px">
                        <el-step title="更新XLS"></el-step>
                        <el-step title="更新Client"></el-step>
                        <el-step title="更新Server"></el-step>
                        <el-step title="导出表"></el-step>
                        <el-step title="提交到客户端"></el-step>
                        <el-step title="提交到服务端"></el-step>
                        <el-step title="结束"></el-step>
                    </el-steps>
                    <br></br>
                    <font face="微软雅黑" color="gray" size="4" style="font-weight:550;">协议</font>
                    <el-divider content-position="right">
                        <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                            <el-button type="success" :icon="task.proto.isbuild?'el-icon-loading':'el-icon-grape'"
                                :disabled="disabled" @click="buildproto()" round>Build</el-button>
                        </el-tooltip>
                    </el-divider>

                    <el-steps :active="task.proto.phase" simple style="margin-top: 20px">
                        <el-step title="更新Protos"></el-step>
                        <el-step title="更新Client"></el-step>
                        <el-step title="更新Server"></el-step>
                        <el-step title="生成"></el-step>
                        <el-step title="提交到客户端"></el-step>
                        <el-step title="提交到服务端"></el-step>
                        <el-step title="结束"></el-step>
                    </el-steps>
                    <br></br>
                    <font face="微软雅黑" color="gray" size="4" style="font-weight:550;">客户端</font>
                    <el-divider content-position="right">
                        <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                            <el-button type="primary" :icon="task.client.isbuild?'el-icon-loading':'el-icon-grape'"
                                :disabled="disabled" @click="buildclient()" round>Build</el-button>
                        </el-tooltip>
                    </el-divider>

                    <el-steps :active="task.client.phase" simple style="margin-top: 20px">
                        <el-step title="更新Client"></el-step>
                        <el-step title="编译"></el-step>
                        <el-step title="结束"></el-step>
                    </el-steps>
                    <br></br>
                    <font face="微软雅黑" color="gray" size="4" style="font-weight:550;">服务端 </font>
                    <el-divider content-position="right">
                        <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                            <el-button type="success" :icon="task.server.isbuild?'el-icon-loading':'el-icon-apple'"
                                :disabled="disabled" @click="buildserver()" round>Build</el-button>
                        </el-tooltip>
                    </el-divider>

                    <el-steps :active="task.server.phase" simple style="margin-top: 20px">
                        <el-step title="更新Server"></el-step>
                        <el-step title="编译"></el-step>
                        <el-step title="结束"></el-step>
                    </el-steps>
                    <br></br>
                    <font face="微软雅黑" color="gray" size="4" style="font-weight:550;">全部构建</font>
                    <el-divider content-position="right">
                        <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                            <el-button type="primary" :icon="task.all.isbuild?'el-icon-loading':'el-icon-cold-drink'"
                                :disabled="disabled" @click="buildall()" round>Build</el-button>
                        </el-tooltip>
                    </el-divider>

                    <el-steps :active="task.all.phase" simple style="margin-top: 20px">
                        <el-step title="更新XLS"></el-step>
                        <el-step title="更新Client"></el-step>
                        <el-step title="更新Server"></el-step>
                        <el-step title="导出表"></el-step>
                        <el-step title="提交到Client"></el-step>
                        <el-step title="提交到Server"></el-step>
                        <el-step title="编译Client"></el-step>
                        <el-step title="编译Server"></el-step>
                        <el-step title="结束"></el-step>
                    </el-steps>
                </el-main>

                <el-footer style="text-align: center;color: #888888;">
                    {{word}}
                </el-footer>
            </el-container>
            <el-aside width="500px">
                <el-divider content-position="center">日志
                    <el-tooltip class="item" effect="dark" content="清空日志" placement="top">
                        <el-button type="warning" icon="el-icon-delete" style="margin-right:0px" size="mini"
                            @click="clearlog()" circle></el-button>
                    </el-tooltip>
                </el-divider>

                <textarea rows="3" cols="20"
                    style="margin-right:10px;width:98%;height:880px;resize: none;outline:none;border:solid 1px #ccc; "
                    readonly="readonly">{{logger}}</textarea>
            </el-aside>
        </el-container>
    </div>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                logger: 'logger',
                disabled: true,
                curtask: null,
                task: {
                    config: {
                        maxtask: 7,
                        isbuild: false,
                        phase: 0
                    },
                    proto: {
                        maxtask: 7,
                        isbuild: false,
                        phase: 0
                    },
                    client: {
                        maxtask: 3,
                        isbuild: false,
                        phase: 0
                    },
                    server: {
                        maxtask: 3,
                        isbuild: false,
                        phase: 0
                    },
                    all: {
                        maxtask: 9,
                        isbuild: false,
                        phase: 0
                    },
                },
                words: [
                    "为天下苍生，太沉重了。就为了自己，好吗？（奇经）",
                    "天神的责任，就是守护世间正道。什么是正道？是不会随时代变迁的一种价值。乌云纵使有时会遮天蔽日。但黑的东西不会变成白。这是每个天神心中不变的价值和信念。与内心的领悟、灵性的提升无关……暗魂就是暗魂。暗魂就是没格调。有自尊自重的天神岂可与你为伍！",
                    "对所有事情都保持中立，实则助长邪恶",
                    "当生活压迫到你窒息的时候。每天就只有短暂的休息时间，可以忘记痛苦。",
                    "无知是一切灾祸的根源",
                    "打败我？这个条件太苛刻，几乎不可能做到。（罗睺）",
                    "男人就该做一件轰轰烈烈的事。（猪八戒）",
                    "我睡了十六年，这一句惊醒了我！我，睡够了！（唐三藏）",
                    "人生就是一连串的遗憾，有些话我遗憾过去没有对你说，太迟了，现在什么也不必再说。（沙悟净）",
                    "在云外天绕了一圈回来，应该不会太迟吧....（三眼神将）"
                ],
                wordprogress: 0,
                word: '',
                ws: null
            },
            mounted: function () {

                function tweentext() {
                    this.wordprogress = 0;
                    var result = this.words[(Math.random() * this.words.length) >> 0];
                    TweenLite.to(this, 1, { wordprogress: 1, onUpdate: updatetext.bind(this), onUpdateParams: [result], ease: Elastic.easeInOut });
                }
                function updatetext(result) {
                    if (this.wordprogress == 1) {
                        this.word = result;
                        return;
                    }
                    var chartotal = this.word.length + ((((result.length - this.word.length)) * this.wordprogress) >> 0);
                    var fixtotal = ((result.length * this.wordprogress) * this.wordprogress) >> 0;
                    var chars = '';
                    for (var i = 0; i < chartotal; i++) {
                        if (i < fixtotal) {
                            chars += result.charAt(i);
                        } else {
                            chars += this.word.charAt((Math.random() * this.word.length) >> 0);
                        }
                    }
                    this.word = chars;
                }

                tweentext.call(this);
                setInterval(() => {
                    tweentext.call(this);
                }, 5000)

                this.ws = new WebSocket("ws://192.168.0.30:14739");
                this.ws.onopen = (e) => {
                    console.log('Connection to server opened');
                    this.ws.send(JSON.stringify({ build: 'state' }));
                }
                this.ws.onmessage = (msg) => {
                    var data = JSON.parse(msg.data);
                    switch (data.type) {
                        case 'state':
                            this.update(data);
                            break;
                        case 'log':
                            this.updatelog(data.content);
                            break;
                    }
                }
            },
            methods: {
                request: function (url, time, callback) {
                    var urlrequest = new XMLHttpRequest();
                    var timeout = false;
                    var timer = setTimeout(function () {
                        timeout = true;
                        urlrequest.abort();
                    }, time);
                    urlrequest.open("GET", url);
                    urlrequest.onreadystatechange = function () {
                        if (urlrequest.readyState !== 4) return;
                        if (timeout) return;
                        clearTimeout(timer);
                        if (urlrequest.status === 200) {
                            callback(urlrequest.responseText);
                        }
                    }
                    urlrequest.send(null);
                },
                update: function (data) {
                    console.log(data);
                    this.disabled = false;
                    this.task.config.isbuild = data.task.config.isrun;
                    this.task.config.phase = data.task.config.phase;

                    this.task.proto.isbuild = data.task.proto.isrun;
                    this.task.proto.phase = data.task.proto.phase;

                    this.task.client.isbuild = data.task.client.isrun;
                    this.task.client.phase = data.task.client.phase;

                    this.task.server.isbuild = data.task.server.isrun;
                    this.task.server.phase = data.task.server.phase;

                    this.task.all.isbuild = data.task.all.isrun;
                    this.task.all.phase = data.task.all.phase;
                },
                updatelog(content) {
                    this.logger += '\n' + decodeURI(content);
                },
                clearlog() {
                    this.logger = "";
                },
                buildconfig: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建配置', type: 'success' });
                    this.ws.send(JSON.stringify({ build: 'config' }));
                },
                buildproto: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建协议', type: 'success' });
                    this.ws.send(JSON.stringify({ build: 'proto' }));
                },
                buildclient: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建客户端', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'client' }));
                },
                buildserver: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建服务器', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'server' }));
                },
                buildall: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始全部构建', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'all' }));
                },
                isbuild: function () {
                    return this.task.config.isbuild || this.task.client.isbuild || this.task.server.isbuild || this.task.all.isbuild
                }
            }
        })
    </script>
</body>