<head>
    <meta charset="utf-8">
    <title>西行记自动构建</title>
    <meta name="viewport"
        content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="true" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="x5-fullscreen" content="true" />
    <meta name="360-fullscreen" content="true" />
    <style>
        html,
        body {
            -ms-touch-action: none;
            padding: 0;
            border: 0;
            margin: 0;
            height: 100%;
        }
    </style>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 开发环境版本，包含了有帮助的命令行警告 -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>

<body>
    <div id="app">
        <el-container>

            <el-main>
                <el-divider content-position="center">
                    <font face="微软雅黑" color="gray" size="5" style="font-weight:550;font-style:italic">构建配置 |</font>
                    <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                        <el-button type="primary" :icon="task.config.isbuild?'el-icon-loading':'el-icon-sugar'" :disabled="disabled"
                            @click="buildconfig()" circle>
                        </el-button>
                    </el-tooltip>
                </el-divider>
                <br></br>
                <el-steps :active="task.config.phase" simple style="margin-top: 20px">
                    <el-step title="更新XLS"></el-step>
                    <el-step title="导出表"></el-step>
                    <el-step title="提交到客户端"></el-step>
                    <el-step title="提交到服务端"></el-step>
                    <el-step title="结束"></el-step>
                </el-steps>
                <br></br>
                <el-divider content-position="center">
                    <font face="微软雅黑" color="gray" size="5" style="font-weight:550;font-style:italic">构建客户端 |</font>
                    <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                        <el-button type="primary" :icon="task.client.isbuild?'el-icon-loading':'el-icon-grape'" :disabled="disabled"
                            @click="buildclient()" circle></el-button>
                    </el-tooltip>
                </el-divider>
                <br></br>
                <el-steps :active="task.client.phase" simple style="margin-top: 20px">
                    <el-step title="更新Client"></el-step>
                    <el-step title="编译"></el-step>
                    <el-step title="结束"></el-step>
                </el-steps>
                <br></br>
                <el-divider content-position="center">
                    <font face="微软雅黑" color="gray" size="5" style="font-weight:550;font-style:italic">构建服务端 |</font>
                    <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                        <el-button type="primary" :icon="task.server.isbuild?'el-icon-loading':'el-icon-apple'" :disabled="disabled"
                            @click="buildserver()" circle></el-button>
                    </el-tooltip>
                </el-divider>
                <br></br>
                <el-steps :active="task.server.phase" simple style="margin-top: 20px">
                    <el-step title="更新Server"></el-step>
                    <el-step title="编译"></el-step>
                    <el-step title="结束"></el-step>
                </el-steps>
                <br></br>
                <el-divider content-position="center">
                    <font face="微软雅黑" color="gray" size="5" style="font-weight:550;font-style:italic">全部构建 |</font>
                    <el-tooltip class="item" effect="dark" content="开始构建" placement="top" style="font-size:150%">
                        <el-button type="primary" :icon="task.all.isbuild?'el-icon-loading':'el-icon-cold-drink'" :disabled="disabled"
                            @click="buildall()" circle></el-button>
                    </el-tooltip>
                </el-divider>
                <br></br>
                <el-steps :active="task.all.phase" simple style="margin-top: 20px">
                    <el-step title="更新XLS"></el-step>
                    <el-step title="更新Client"></el-step>
                    <el-step title="更新Server"></el-step>
                    <el-step title="导出表"></el-step>
                    <el-step title="提交到Client"></el-step>
                    <el-step title="提交到Server"></el-step>
                    <el-step title="编译Client"></el-step>
                    <el-step title="编译Server"></el-step>
                    <el-step title="结束"></el-step>
                </el-steps>
            </el-main>

            <el-footer>
                <el-divider content-position="left">日志</el-divider>
                <textarea rows="3" cols="20" style="width:100%;height:290px;resize: none;outline:none;border:solid 1px #ccc; " readonly="readonly">{{logger}}</textarea>
            </el-footer>
        </el-container>
    </div>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                logger: 'logger',
                disabled:true,
                curtask: null,
                task: {
                    config: {
                        maxtask: 5,
                        isbuild: false,
                        phase: 0
                    },
                    client: {
                        maxtask: 3,
                        isbuild: false,
                        phase: 0
                    },
                    server: {
                        maxtask: 3,
                        isbuild: false,
                        phase: 0
                    },
                    all: {
                        maxtask: 9,
                        isbuild: false,
                        phase: 0
                    },
                },
                ws: null
            },
            mounted: function () {
                this.ws = new WebSocket("ws://192.168.0.30:14739");
                this.ws.onopen = (e) => {
                    console.log('Connection to server opened');
                    this.ws.send(JSON.stringify({ build: 'state'  }));
                }
                this.ws.onmessage = (msg) => {
                    var data = JSON.parse(msg);
                    switch(data.type){
                        case 'state':
                        this.update(data);
                        break;
                        case 'log':

                        break;
                    }
                }
            },
            methods: {
                request: function (url, time, callback) {
                    var urlrequest = new XMLHttpRequest();
                    var timeout = false;
                    var timer = setTimeout(function () {
                        timeout = true;
                        urlrequest.abort();
                    }, time);
                    urlrequest.open("GET", url);
                    urlrequest.onreadystatechange = function () {
                        if (urlrequest.readyState !== 4) return;
                        if (timeout) return;
                        clearTimeout(timer);
                        if (urlrequest.status === 200) {
                            callback(urlrequest.responseText);
                        }
                    }
                    urlrequest.send(null);
                },
                update: function (data) {
                    console.log(data);
                    this.disabled=false;
                    this.task.config.isbuild = data.task.config.isrun;
                    this.task.config.phase = data.task.config.phase;

                    this.task.client.isbuild = data.task.client.isrun;
                    this.task.client.phase = data.task.client.phase;

                    this.task.server.isbuild = data.task.server.isrun;
                    this.task.server.phase = data.task.server.phase;

                    this.task.all.isbuild = data.task.all.isrun;
                    this.task.all.phase = data.task.all.phase;
                },
                updatelog(content){
                    this.logger += '\n' + decodeURI(content);
                },
                buildconfig: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建配置', type: 'success' });
                    this.ws.send(JSON.stringify({ build: 'config' }));
                },
                buildclient: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建客户端', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'client' }));
                },
                buildserver: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始构建服务器', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'server' }));
                },
                buildall: function () {
                    if (this.isbuild()) {
                        this.$notify({ message: '请等待任务构建完成...', type: 'warning' });
                        return;
                    }
                    this.$notify({ message: '开始全部构建', type: 'warning' });
                    this.ws.send(JSON.stringify({ build: 'all' }));
                },
                isbuild: function () {
                    return this.task.config.isbuild || this.task.client.isbuild || this.task.server.isbuild || this.task.all.isbuild
                }
            }
        })
    </script>
</body>